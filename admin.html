<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MANUS ê´€ë¦¬ì</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
:root{
  --bg:#eef2f7;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --primary:#2563eb;
  --danger:#ef4444;
  --radius:22px;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  color:var(--text);
}
.container{
  max-width:520px;
  margin:0 auto;
  padding:20px 16px 110px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:18px;
  box-shadow:0 14px 30px rgba(0,0,0,.12);
}
h2{margin:0 0 12px;font-size:18px}
label{
  font-size:14px;
  display:flex;
  gap:8px;
  align-items:center;
  margin:8px 0 10px;
  color:var(--text);
}

input, textarea, select, button{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  margin-bottom:10px;
  font-size:16px;          /* iOS í™•ëŒ€ ë°©ì§€ */
  outline:none;
}
textarea{resize:vertical; min-height:110px}
button{
  background:var(--primary);
  color:#fff;
  border:none;
  font-weight:800;
  cursor:pointer;
  transition:transform .06s ease, opacity .12s ease;
}
button:active{transform:scale(.99)}
button[disabled]{opacity:.55; cursor:not-allowed}

.hidden{display:none}
img.preview{
  width:100%;
  border-radius:16px;
  margin:6px 0 12px;
  max-height:220px;
  object-fit:cover;
  background:#f3f4f6;
}

/* í›„ê¸° ì¹´ë“œ */
.review{
  background:#f8fafc;
  border-radius:16px;
  padding:12px;
  margin-bottom:10px;
  border:1px solid #eef2f7;
}
.review b{display:block; margin-bottom:6px}
.review .meta{color:var(--muted); font-size:12px; margin-bottom:6px}
.review .btn-del{
  background:var(--danger);
  margin-top:8px;
}

/* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
#loadingOverlay{
  position:fixed;
  inset:0;
  background:rgba(17,24,39,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.loading-box{
  width:min(320px, 86vw);
  background:rgba(255,255,255,.92);
  border-radius:18px;
  padding:18px 16px;
  box-shadow:0 22px 60px rgba(0,0,0,.25);
  text-align:center;
}
.spinner{
  width:40px;
  height:40px;
  border-radius:999px;
  border:4px solid rgba(37,99,235,.20);
  border-top-color:rgba(37,99,235,1);
  margin:0 auto 10px;
  animation:spin 0.9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
#loadingMsg{font-weight:800; font-size:14px; color:#111827}
#loadingSub{margin-top:6px; color:#6b7280; font-size:12px}

/* ===== í† ìŠ¤íŠ¸ ===== */
#toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  width:min(520px, calc(100vw - 24px));
  z-index:10000;
  pointer-events:none;
}
.toast-item{
  margin:10px auto 0;
  background:rgba(17,24,39,.92);
  color:#fff;
  border-radius:16px;
  padding:12px 14px;
  box-shadow:0 18px 42px rgba(0,0,0,.28);
  display:flex;
  gap:10px;
  align-items:flex-start;
  animation:toastIn .22s ease;
}
.toast-icon{
  width:22px; height:22px; flex:0 0 22px;
  display:flex; align-items:center; justify-content:center;
  font-weight:900;
}
.toast-text{flex:1}
.toast-title{font-weight:900; font-size:14px; margin-bottom:2px}
.toast-desc{font-size:12px; color:rgba(255,255,255,.85); line-height:1.35}
.toast-item.success{background:rgba(22,163,74,.95)}
.toast-item.error{background:rgba(239,68,68,.95)}
@keyframes toastIn{
  from{opacity:0; transform:translateY(8px)}
  to{opacity:1; transform:translateY(0)}
}

/* ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 480px){
  .container{padding:16px 12px 120px}
  .card{padding:16px; border-radius:20px}
  h2{font-size:17px}
  img.preview{max-height:190px}
}
</style>
</head>

<body>
<div class="container">

  <!-- ë¡œê·¸ì¸ -->
  <div class="card" id="loginBox">
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <input type="password" id="pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (0708)" />
    <button type="button" id="btnLogin" onclick="login()">ë¡œê·¸ì¸</button>
    <div style="color:var(--muted); font-size:12px; margin-top:6px;">
      * ë¡œê·¸ì¸ í›„ì—ë§Œ ì €ì¥/ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
  </div>

  <!-- ê´€ë¦¬ì -->
  <div id="adminBox" class="hidden">

    <!-- í”„ë¡œí•„ -->
    <div class="card">
      <h2>ğŸ‘¤ í”„ë¡œí•„ ê´€ë¦¬</h2>
      <input type="file" id="profileImg" accept="image/*" />
      <img id="profilePreview" class="preview" alt="í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°" />
      <input id="profileName" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ìƒì¼ ë§¤ë‹ˆì €)" />
      <input id="profileDesc" placeholder="ì†Œê°œ ë¬¸êµ¬ (ì˜ˆ: KTí”Œë¼ì ì¤‘ê³„ì•„ìš¸ë ›ì )" />
      <button type="button" id="btnSaveProfile" onclick="saveProfile()">í”„ë¡œí•„ ì €ì¥</button>
    </div>

    <!-- íŒ¨í‚¤ì§€ -->
    <div class="card">
      <h2>ğŸ“¦ íŒ¨í‚¤ì§€ ê´€ë¦¬</h2>
      <select id="pkgKey">
        <option value="galaxy">ê°¤ëŸ­ì‹œ</option>
        <option value="iphone">ì•„ì´í°</option>
        <option value="award">ìˆ˜ìƒ Â· ê²½ë ¥</option>
        <option value="review">ê³ ê° í›„ê¸°</option>
      </select>

      <label>
        <input type="checkbox" id="pkgVisible" checked />
        ë°©ë¬¸ìì—ê²Œ ë…¸ì¶œ
      </label>

      <input type="file" id="pkgImg" accept="image/*,.gif" />
      <img id="pkgPreview" class="preview" alt="íŒ¨í‚¤ì§€ ë¯¸ë¦¬ë³´ê¸°" />
      <textarea id="pkgText" placeholder="íŒ¨í‚¤ì§€ ì„¤ëª…(ê¸€)"></textarea>
      <button type="button" id="btnSavePkg" onclick="savePackage()">íŒ¨í‚¤ì§€ ì €ì¥</button>
      <div style="color:var(--muted); font-size:12px;">
        * ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì§€ ì•Šê³  ì €ì¥í•˜ë©´ ê¸€/ë…¸ì¶œë§Œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- í›„ê¸° -->
    <div class="card">
      <h2>â­ ê³ ê° í›„ê¸° ê´€ë¦¬</h2>
      <div id="reviewList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- í†µê³„ -->
    <div class="card">
      <h2>ğŸ“Š í›„ê¸° í†µê³„</h2>
      <div id="stats">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

  </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <div id="loadingMsg">ì²˜ë¦¬ ì¤‘...</div>
    <div id="loadingSub">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast"></div>

<script>
/* =========================
   Firebase ì´ˆê¸°í™”
========================= */
firebase.initializeApp({
  apiKey:"AIzaSyA9oBNryhEX9nYOfxXJndOhR8aybEijr78",
  authDomain:"manus-card.firebaseapp.com",
  databaseURL:"https://manus-card-default-rtdb.firebaseio.com",
  projectId:"manus-card",
  storageBucket:"manus-card.firebasestorage.app"
});
const db = firebase.database();
const st = firebase.storage();

/* =========================
   UX helpers: Loading / Toast
========================= */
let busyCount = 0;

function setBusy(on, msg="ì²˜ë¦¬ ì¤‘...", sub="ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”"){
  if(on){
    busyCount++;
    loadingMsg.textContent = msg;
    loadingSub.textContent = sub;
    loadingOverlay.style.display = "flex";
    disableAllButtons(true);
  }else{
    busyCount = Math.max(0, busyCount-1);
    if(busyCount === 0){
      loadingOverlay.style.display = "none";
      disableAllButtons(false);
    }
  }
}

function disableAllButtons(disabled){
  document.querySelectorAll("button").forEach(b=>{
    // ë¡œê·¸ì¸ë°•ìŠ¤ ìˆ¨ê²¨ì§„ ìƒíƒœì—ì„œë„ ë¹„í™œì„±í™” ë˜ì§€ë§Œ ìƒê´€ì—†ìŒ
    b.disabled = disabled;
  });
}

function toast(type, title, desc=""){
  const el = document.createElement("div");
  el.className = `toast-item ${type}`;
  const icon = type === "success" ? "âœ“" : type === "error" ? "!" : "i";
  el.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-text">
      <div class="toast-title">${escapeHtml(title)}</div>
      ${desc ? `<div class="toast-desc">${escapeHtml(desc)}</div>` : ``}
    </div>
  `;
  toast.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 2400);
  setTimeout(()=>{ el.remove(); }, 2900);
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}

/* =========================
   ë¡œê·¸ì¸
========================= */
function login(){
  if(pw.value === "0708"){
    loginBox.style.display="none";
    adminBox.classList.remove("hidden");
    toast("success","ë¡œê·¸ì¸ ì„±ê³µ","ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    hydrateProfile();
    hydratePackageUI();  // ì„ íƒëœ íŒ¨í‚¤ì§€ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    loadReviews();
  }else{
    toast("error","ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜","ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
}

/* =========================
   í”„ë¡œí•„: ê¸°ì¡´ ê°’ ë¡œë“œ + ì €ì¥
========================= */
function hydrateProfile(){
  db.ref("profile").once("value").then(snap=>{
    const p = snap.val() || {};
    profileName.value = p.name || "";
    profileDesc.value = p.desc || "";
    profilePreview.src = p.img || "";
  }).catch(err=>{
    toast("error","í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨", err.message || String(err));
  });
}

function saveProfile(){
  const file = profileImg.files[0];
  const name = profileName.value.trim();
  const desc = profileDesc.value.trim();

  if(!name || !desc){
    return toast("error","ì…ë ¥ í•„ìš”","ì´ë¦„/ì†Œê°œ ë¬¸êµ¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  }

  // ì´ë¯¸ì§€ê°€ ì—†ì–´ë„ í…ìŠ¤íŠ¸ë§Œ ì €ì¥ ê°€ëŠ¥í•˜ê²Œ (PC/ëª¨ë°”ì¼ ëª¨ë‘ í¸í•¨)
  if(!file){
    setBusy(true,"í”„ë¡œí•„ ì €ì¥ ì¤‘...","í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ìˆì–´ìš”");
    db.ref("profile").update({ name, desc })
      .then(()=>{
        toast("success","í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ","ì´ë¦„/ì†Œê°œê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
      })
      .catch(err=>{
        toast("error","ì €ì¥ ì‹¤íŒ¨", err.message || String(err));
      })
      .finally(()=>setBusy(false));
    return;
  }

  setBusy(true,"í”„ë¡œí•„ ì €ì¥ ì¤‘...","ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ìˆì–´ìš”");
  st.ref("profile/profile").put(file).then(s =>
    s.ref.getDownloadURL().then(url=>{
      return db.ref("profile").set({ name, desc, img:url }).then(()=>{
        profilePreview.src = url;
        toast("success","í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ","ë°©ë¬¸ì í˜ì´ì§€ì— ë°”ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.");
      });
    })
  ).catch(err=>{
    toast("error","ì €ì¥ ì‹¤íŒ¨", err.message || String(err));
  }).finally(()=>{
    setBusy(false);
    profileImg.value = "";
  });
}

/* =========================
   íŒ¨í‚¤ì§€: ì„ íƒì‹œ ê¸°ì¡´ ê°’ ë¡œë“œ + ì €ì¥
========================= */
pkgKey.addEventListener("change", hydratePackageUI);

function hydratePackageUI(){
  const key = pkgKey.value;
  db.ref("packages/"+key).once("value").then(snap=>{
    const d = snap.val() || {};
    pkgText.value = d.text || "";
    pkgVisible.checked = (d.visible !== false);
    pkgPreview.src = d.img || "";
  }).catch(err=>{
    toast("error","íŒ¨í‚¤ì§€ ë¡œë“œ ì‹¤íŒ¨", err.message || String(err));
  });
}

function savePackage(){
  const key = pkgKey.value;
  const visible = pkgVisible.checked;
  const text = pkgText.value.trim();
  const file = pkgImg.files[0];

  if(!text && !file){
    return toast("error","ì…ë ¥ í•„ìš”","ì„¤ëª… ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì…ë ¥/ì„ íƒí•´ì£¼ì„¸ìš”.");
  }

  // ì´ë¯¸ì§€ ì—†ìœ¼ë©´ updateë§Œ
  if(!file){
    setBusy(true,"íŒ¨í‚¤ì§€ ì €ì¥ ì¤‘...", "í…ìŠ¤íŠ¸/ë…¸ì¶œ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ìˆì–´ìš”");
    db.ref("packages/"+key).update({ text, visible })
      .then(()=>{
        toast("success","íŒ¨í‚¤ì§€ ì €ì¥ ì™„ë£Œ", `${key} ë‚´ìš©ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      })
      .catch(err=>{
        toast("error","ì €ì¥ ì‹¤íŒ¨", err.message || String(err));
      })
      .finally(()=>setBusy(false));
    return;
  }

  setBusy(true,"íŒ¨í‚¤ì§€ ì €ì¥ ì¤‘...","ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ìˆì–´ìš”");
  // GIF í¬í•¨ ê°€ëŠ¥: íŒŒì¼ í™•ì¥ì ìœ ì§€ (jpg ê°•ì œ X)
  const ext = (file.name.split(".").pop() || "img").toLowerCase();
  st.ref(`packages/${key}.${ext}`).put(file).then(s =>
    s.ref.getDownloadURL().then(url=>{
      return db.ref("packages/"+key).set({ text, visible, img:url }).then(()=>{
        pkgPreview.src = url;
        toast("success","íŒ¨í‚¤ì§€ ì €ì¥ ì™„ë£Œ","ë°©ë¬¸ì í˜ì´ì§€ì— ë°”ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.");
      });
    })
  ).catch(err=>{
    toast("error","ì €ì¥ ì‹¤íŒ¨", err.message || String(err));
  }).finally(()=>{
    setBusy(false);
    pkgImg.value = "";
  });
}

/* =========================
   í›„ê¸° ë¡œë“œ + ì‚­ì œ + í†µê³„
========================= */
function loadReviews(){
  db.ref("reviews").on("value", snap=>{
    const data = snap.val() || {};
    const entries = Object.entries(data);

    // ë¦¬ìŠ¤íŠ¸
    reviewList.innerHTML = "";
    if(entries.length === 0){
      reviewList.innerHTML = `<div style="color:var(--muted); font-size:13px;">ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }else{
      // ìµœì‹ ìˆœ
      entries.sort((a,b)=> (b[1].time||0) - (a[1].time||0));
      for(const [id, r] of entries){
        const timeStr = r.time ? new Date(r.time).toLocaleString() : "";
        const div = document.createElement("div");
        div.className = "review";
        div.innerHTML = `
          <b>${escapeHtml(r.name || "ìµëª…")} (${Number(r.rating||0)}â˜…)</b>
          <div class="meta">${escapeHtml(timeStr)}</div>
          <div>${escapeHtml(r.text || "")}</div>
          <button type="button" class="btn-del" onclick="delReview('${id}')">ì‚­ì œ</button>
        `;
        reviewList.appendChild(div);
      }
    }

    // í†µê³„
    let sum = 0;
    let cnt = 0;
    for(const [, r] of entries){
      const rt = Number(r.rating||0);
      if(rt > 0){ sum += rt; cnt++; }
    }
    const avg = cnt ? (sum/cnt).toFixed(1) : "0.0";
    stats.innerHTML = `
      ì´ í›„ê¸° ìˆ˜: <b>${entries.length}</b>ê°œ<br>
      í‰ê·  ë³„ì : <b>â­ ${avg}</b>
    `;
  }, err=>{
    toast("error","í›„ê¸° ë¡œë“œ ì‹¤íŒ¨", err.message || String(err));
  });
}

function delReview(id){
  if(!confirm("ì´ í›„ê¸°ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
  setBusy(true,"í›„ê¸° ì‚­ì œ ì¤‘...","ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆì–´ìš”");
  db.ref("reviews/"+id).remove()
    .then(()=>toast("success","ì‚­ì œ ì™„ë£Œ","í›„ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."))
    .catch(err=>toast("error","ì‚­ì œ ì‹¤íŒ¨", err.message || String(err)))
    .finally(()=>setBusy(false));
}

/* =========================
   ë¯¸ë¦¬ë³´ê¸°(ì„ íƒ ì¦‰ì‹œ í‘œì‹œ)
========================= */
profileImg.addEventListener("change", ()=>{
  const f = profileImg.files[0];
  if(!f) return;
  profilePreview.src = URL.createObjectURL(f);
});

pkgImg.addEventListener("change", ()=>{
  const f = pkgImg.files[0];
  if(!f) return;
  pkgPreview.src = URL.createObjectURL(f);
});
</script>
</body>
</html>
